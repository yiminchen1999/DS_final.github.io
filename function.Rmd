---
title: "function"
output: github_document
---
```{r}
library(faraway)
library(tidyverse)
library(dplyr)
library(broom)
library(glmnet)
library(olsrr)
library(MASS)
library(caret)
library(modelr)

options(digits = 7)
```
This will be model building procedure...
```{r}
sq_df = read_csv('squirrel_tidy.csv') %>% 
  janitor::clean_names()
```

```{r}
# longitudinal/latitudinal function
# raw data input (no hectare information because the user would not know the info. about it)
long_model =
  lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
summary(long_model)
print(long_model)

lat_model =
  lm(lat ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
summary(lat_model)
print(lat_model)
```

```{r}
# model selection using p-value
long_model1 = 
  lm(long ~ shift + age + activity + reaction + sounds, data = sq_df)
summary(long_model1)
print(long_model1)

lat_model1 =
  lm(lat ~ primary_fur_color + reaction + sounds, data = sq_df)
summary(lat_model1)
print(lat_model1)
```

```{r}
# model selection using automatic procedure (forward/backward)
model_stepwise_long <- lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_both_p(model_stepwise_long)

model_stepwise_lat <- lm(lat ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_both_p(model_stepwise_lat)
```

```{r}
# model selection using criterion-based procedure
model_criterion_long = lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_best_subset(model_criterion_long)

model_criterion_lat <- lm(lat ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_best_subset(model_criterion_lat)
```

```{r}
# model selection using LASSO procedure: longitude
y_long <- sq_df$long
hist(y_long)
x <- sq_df %>% 
  dplyr::select(
    shift, age, primary_fur_color,location, activity, reaction, sounds
    ) %>%
  data.matrix()

set.seed(2022)
cv_model_long <- cv.glmnet(x,y_long, alpha = 1)
(best_lambda_long <- cv_model_long$lambda.min)
long_lasso <- glmnet(x, y_long, alpha = 1, lambda = best_lambda_long)
coef(long_lasso)
```

```{r}
# model selection using LASSO procedure: latitude
y_lat <- sq_df$lat
hist(y_lat)
x <- sq_df %>% 
  dplyr::select(
    shift, age, primary_fur_color,location, activity, reaction, sounds
    ) %>%
  data.matrix()

set.seed(2023)
cv_model_lat <- cv.glmnet(x,y_lat, alpha = 1)
(best_lambda_lat <- cv_model_lat$lambda.min)
lat_lasso <- glmnet(x, y_lat, alpha = 1, lambda = best_lambda_lat)
coef(lat_lasso)

```

```{r}
# model comparisons for long
long_model2 = 
  lm(long ~ sounds + reaction + age + activity + shift + primary_fur_color, data = sq_df)
summary(long_model1)
summary(long_model2)

```

```{r}
# model comparisons for lat
lat_model2 = 
  lm(lat ~ sounds + primary_fur_color + reaction + activity + shift, data = sq_df)
lat_model3 = 
  lm(lat ~ sounds + reaction + age + activity + shift + primary_fur_color, data = sq_df)
summary(lat_model1)
summary(lat_model2)
summary(lat_model3)
```

```{r}
set.seed(1)
# Use 10-fold validation 
train = trainControl(method = "cv", number = 10)
y1 <- data.frame(cbind(sq_df$long, sq_df$lat))
model_caret1 = train(long ~ primary_fur_color + reaction + sounds, data = sq_df,
trControl = train,
method = 'lm',
na.action = na.pass)

# fitting a regression line
model_caret1$finalModel
model_caret1
model_caret2 = train(lat ~ primary_fur_color + reaction + sounds, data = sq_df,
trControl = train,
method = 'lm',
na.action = na.pass)

# fitting a regression line
model_caret2$finalModel
model_caret2
```

# latitudinal model selection
```{r}
# latitudinal data function
lat_model =
  lm(lat ~ hectare_squirrel_number + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
summary(lat_model)
```


pvalue_fit_lat = lm(lat ~ primary_fur_color + reaction + sounds, data = sq_df)
pvalue_adjrsquared_lat <- summary(pvalue_fit_lat)$adj.r.squared

auto_fit_lat = lm(lat ~ sounds + primary_fur_color + reaction + activity + shift ,data = sq_df)
auto_adjrsquared_lat <- summary(auto_fit_lat)$adj.r.squared

crit_fit_lat = lm(lat ~ shift + age + primary_fur_color + activity +  reaction + sounds, data = sq_df)
crit_adjrsquared_lat <- summary(crit_fit_lat)$adj.r.squared

lasso_fit_lat = lm(lat ~ shift + age + primary_fur_color + activity + reaction + sounds, data = sq_df)

```{r}
# all latitude models
pvalue_fit_lat = lm(lat ~ primary_fur_color + reaction + sounds, data = sq_df)
pvalue_adjrsquared_lat <- summary(pvalue_fit_lat)$adj.r.squared

auto_fit_lat = lm(lat ~ sounds + primary_fur_color + reaction + activity + shift ,data = sq_df)
auto_adjrsquared_lat <- summary(auto_fit_lat)$adj.r.squared

crit_fit_lat = lm(lat ~ shift + age + primary_fur_color + activity +  reaction + sounds, data = sq_df)
crit_adjrsquared_lat <- summary(crit_fit_lat)$adj.r.squared

lasso_fit_lat = lm(lat ~ shift + age + primary_fur_color + activity + reaction + sounds, data = sq_df)
lasso_adjrsquared_lat <- summary(lasso_fit_lat)$adj.r.squared

```

# longitudinal model selection
model_pvalue = lm(long ~ shift + age + activity + reaction + sounds, data = sq_df)

model_criterion = lm(cbind(long, lat) ~ shift + hectare_squirrel_number + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_best_subset(model_criterion)

model_stepwise <- lm(long ~ hectare_squirrel_number + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
ols_step_both_p(model_stepwise)

model_lasso = lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)

```{r}
# all longitude models
pvalue_fit_long = lm(long ~ shift + age + activity + reaction + sounds, data = sq_df)
pvalue_adjrsquared_long <- summary(pvalue_fit_long)$adj.r.squared

auto_fit_long = lm(long ~ sounds + primary_fur_color + reaction + activity + shift ,data = sq_df)
auto_adjrsquared_long <- summary(auto_fit_long)$adj.r.squared

crit_fit_long = lm(long ~ shift + age + primary_fur_color + activity + reaction + sounds, data = sq_df)
crit_adjrsquared_long <- summary(crit_fit_long)$adj.r.squared

lasso_fit_long = lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = sq_df)
lasso_adjrsquared_long <- summary(lasso_fit_long)$adj.r.squared
```


```{r}
# cross- validation
cv_df <- crossv_mc(sq_df, 100)
cv_df <- cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
```

```{r}
# latitudinal model selection
cv_df_lat = 
  cv_df %>% 
  mutate(
    pvalue_fit = map(train, ~lm(lat ~ primary_fur_color + reaction + sounds, data = .x)),
    auto_fit = map(train, ~lm(lat ~ sounds + primary_fur_color + reaction + activity + shift ,data = .x)),
    crit_fit = map(train, ~lm(lat ~ shift + age + primary_fur_color + activity +  reaction + sounds, data = .x)),
    lasso_fit = map(train, ~lm(lat ~ shift + age + primary_fur_color + activity + reaction + sounds, data = .x))
  ) %>%
  mutate(
    rmse_pvalue = map2_dbl(pvalue_fit, test, ~rmse(model = .x, data = .y)),
    rmse_auto = map2_dbl(auto_fit, test, ~rmse(model = .x, data = .y)),
    rmse_crit = map2_dbl(crit_fit, test, ~rmse(model = .x, data = .y)),
    rmse_lasso = map2_dbl(lasso_fit, test, ~rmse(model = .x, data = .y))
  )

# Comparing the RMSE
cv_df_lat %>% 
  dplyr::select(starts_with('rmse_')) %>% 
  map(median)

cv_df_lat %>% 
  dplyr::select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(
    title = 'RMSE for Cross Validation of Latitude Models',
       x = 'models', y = 'RMSE'
  )
```

```{r}
cv_df_long = 
  cv_df %>% 
  mutate(
    pvalue_fit = map(train, ~lm(long ~ shift + age + activity + reaction + sounds, data = .x)),
    auto_fit = map(train, ~lm(long ~ sounds + primary_fur_color + reaction + activity + shift ,data = .x)),
    crit_fit = map(train, ~lm(long ~ shift + age + primary_fur_color + activity + reaction + sounds, data = .x)),
    lasso_fit = map(train, ~lm(long ~ shift + age + primary_fur_color + location + activity + reaction + sounds, data = .x))
  ) %>% 
  mutate(
    rmse_pvalue = map2_dbl(pvalue_fit, test, ~rmse(model = .x, data = .y)),
    rmse_auto = map2_dbl(auto_fit, test, ~rmse(model = .x, data = .y)),
    rmse_crit = map2_dbl(crit_fit, test, ~rmse(model = .x, data = .y)),
    rmse_lasso = map2_dbl(lasso_fit, test, ~rmse(model = .x, data = .y))
  )

# Comparing the RMSE
cv_df_long %>% 
  dplyr::select(starts_with('rmse_')) %>% 
  map(median)

cv_df_long %>% 
  dplyr::select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(
    title = 'RMSE for Cross Validation of Longitude Models',
       x = 'models', y = 'RMSE'
  )

```

latitude: automatic method is chosen due to the rule of parsimony.(only 5 predictors while LASSO and criterion-based methods have 6 predictors). When the RMSE distributions are basically same among the methods, the automatic method has slightly lower median both RMSE and Rsquared.

longitude: criterion based method is chosen: lowest median RMSE(since every method's RMSE distribution is pretty similar) and highest adjusted R squared
```{r}
# RMSE and adj Rsqured comparison table
# latitude: automatic method is chosen due to the rule of parsimony.(only 5 predictors while LASSO and criterion-based methods hava 6 predictors). When the RMSE distributions are basically same among the methods, the automatic method has slightly lower median both RMSE and Rsquared.

methods <- c('pvalue','automatic','criterion-based','LASSO')
RMSE_lat <- 
  cv_df_lat %>% 
  dplyr::select(starts_with('rmse_')) %>% 
  map(median) %>% 
  unlist()

adjrsquared_lat <- c(pvalue_adjrsquared_lat,auto_adjrsquared_lat,
                       crit_adjrsquared_lat, lasso_adjrsquared_lat)
lat_comparison <- tibble(
  methods,
  RMSE_lat, 
  adjrsquared_lat
)
lat_comparison %>% knitr::kable()

#longitude: criterion based method is chosen: lowest median RMSE(since evry method's RMSE distribution is pretty similar) and highest adjusted R squared
RMSE_long <- 
  cv_df_long %>% 
  dplyr::select(starts_with('rmse_')) %>% 
  map(median) %>% 
  unlist()

adjrsquared_long <- c(pvalue_adjrsquared_long,auto_adjrsquared_long,
                       crit_adjrsquared_long, lasso_adjrsquared_long)
long_comparison <- tibble(
  methods,
  RMSE_long, 
  adjrsquared_long
)
long_comparison %>% knitr::kable()

```

```{r}
# final model
long_model_final=
  lm(long ~ shift + age + primary_fur_color + activity + reaction + sounds, data = sq_df)
print(long_model_final)

lat_model_final=
  lm(lat ~ sounds + primary_fur_color + reaction + activity + shift, data = sq_df)
print(lat_model_final)
```